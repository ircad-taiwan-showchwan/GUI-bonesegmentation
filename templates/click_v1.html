<!doctype html>

<html>

<head>

	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='click.css') }}">

<head>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

<body>
<div id="main">
	<!-- Title -->
	<h1>
	CLICK ON A BONE YOU SEE 
	</h1>
	<!-- set the image -->
	<canvas id="canvas" width="500" height="500"></canvas>

	<div id="status"></div><br>

	<div id="color" align="center"></div>

	<div id="pixeldata0"></div>

	<!-- submit button -->
	<form id="form3" action="" class="form-inline pull-left" method="post">

    	<button id="button" class="button" onclick="validate();" type="submit"  value="create3D"> Submit
    	</button>

	</form>

	<br></br> <!-- gives spaces -->

	<p>
	<!-- next button which redirects to the view of the 3D model ( route /view) -->
	<a id="next" onclick="validate();" href="{{ url_for('view') }}"> Next </a>

	</p>


<!-- JAVA SCRIPT -->
<script> 

// get the canvas from html
var canvas = document.getElementById("canvas");

function getElementPosition(obj) {
    var curleft = 0, curtop = 0;
    if (obj.offsetParent) {
        do {
            curleft += obj.offsetLeft;
            curtop += obj.offsetTop;
        } while (obj = obj.offsetParent);
        return { x: curleft, y: curtop };
    }
    return undefined;
}

function getEventLocation(element,event){
		var pos = getElementPosition(element);
    
    return {
    		x: (event.pageX - pos.x),
      	y: (event.pageY - pos.y)
    };
}

function rgbToHex(r, g, b) {
    if (r > 255 || g > 255 || b > 255)
        throw "Invalid color component";
    return ((r << 16) | (g << 8) | b).toString(16);
}

function drawImageFromWebUrl(sourceurl){
      var img = new Image();

      img.addEventListener("load", function () {
          // The image can be drawn from any source
          canvas.getContext("2d").drawImage(img, 0, 0, img.width,    img.height, 0, 0, canvas.width, canvas.height);
          
      });

      img.setAttribute("src", sourceurl);
}
// Draw a base64 image because this is a fiddle, and if we try with an image from URL we'll get tainted canvas error
// Read more about here : http://ourcodeworld.com/articles/read/182/the-canvas-has-been-tainted-by-cross-origin-data-and-tainted-canvases-may-not-be-exported

// we get the URI generated by the python algorithm
var dataURI= {{ dataURI|tojson|safe }};
// alert(dataURI);
drawImageFromWebUrl(dataURI);
canvas.addEventListener("mousemove",function(e){
	var eventLocation = getEventLocation(this,e);
    var coord = "x=" + eventLocation.x + ", y=" + eventLocation.y;
    
    // Get the data of the pixel according to the location generate by the getEventLocation function
    var context = this.getContext('2d');
    var pixelData = context.getImageData(eventLocation.x, eventLocation.y, 1, 1).data; 

    // If transparency on the image
    if((pixelData[0] == 0) && (pixelData[1] == 0) && (pixelData[2] == 0) && (pixelData[3] == 0)){
 				coord += " (Transparent color detected, cannot be converted to HEX)";
    }
    // hex is the color pointed by the mouse 
    var hex = "#" + ("000000" + rgbToHex(pixelData[0], pixelData[1], pixelData[2])).slice(-6);

    // pixeldata0,1,2 are the R G B value of the pixel
    var pixelData0= "Pixel value of the bone = " + pixelData[0]; 
    var pixelData1= "pixelData[1] = " + pixelData[1]; 
    var pixelData2= "pixelData[2]" + pixelData[2]; 

    // Draw the color and coordinates.
    document.getElementById("status").innerHTML = coord;
    document.getElementById("color").style.backgroundColor = hex;

    // I set the value of pixeldata0(html) with pixelData0 
    document.getElementById("pixeldata0").innerHTML = pixelData0;

	var boneValue;
	canvas.onclick = function(event) {

		
 	if (event.which==1 || event.which==2) { // event allows us to know what is going on=n when the user click 
 		 boneValue =pixelData1;  // 1 or 2 depending if it is a right or left click
     	 alert('You have clicked on the image!'+ " " + "The bone value is " +pixelData[1]);
    	                                   }


    								 //};

//ALLOW US TO CLICK ON THE BUTTON AND SENDING DATA INFORMATION TO PYTHON TRHOUGH AJAX
	$('#form3').on('submit', function(event) {

	      $.ajax({
		 data : JSON.stringify({
		    'name' : pixelData[1],
		    'email' : $('#input').val()
		 }),
		 type : 'POST',
		 url : '{{url_for('model')}}',
		 contentType: 'application/json;charset=UTF-8',
		  success: function() {window.location.href = '{{url_for('click')}}'}
	      });
	      event.preventDefault();

							});

   };

 });
</script>
</div>

<div class ="barre">
    <p class="logo_center text-center"> </p>
    <img id="t_logo" src="{{ url_for('static', filename='logo.png')}}">
</div> 

</body>
</html>
